name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

# å–æ¶ˆåŒä¸€ PR ä¸Šçš„æ—§å·¥ä½œæµè¿è¡Œ
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # å¿«é€Ÿæ£€æŸ¥ - å¹¶è¡Œè¿è¡Œæ‰€æœ‰æ£€æŸ¥
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm run test
        continue-on-error: true

  # æ£€æŸ¥ PR ä¿¡æ¯
  pr-info:
    name: PR Info
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files_yaml: |
            sdk:
              - packages/sdk/**
            server:
              - packages/server/**
            shared:
              - packages/shared/**
            docs:
              - docs/**
              - '**.md'
            config:
              - package.json
              - tsconfig*.json
              - .github/**

      - name: Summary
        run: |
          echo "### ðŸ“ Changed Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changed-files.outputs.sdk_any_changed }}" == "true" ]; then
            echo "- ðŸ“¦ **SDK** changed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed-files.outputs.server_any_changed }}" == "true" ]; then
            echo "- ðŸ–¥ï¸ **Server** changed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed-files.outputs.shared_any_changed }}" == "true" ]; then
            echo "- ðŸ”— **Shared** changed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]; then
            echo "- ðŸ“š **Docs** changed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed-files.outputs.config_any_changed }}" == "true" ]; then
            echo "- âš™ï¸ **Config** changed" >> $GITHUB_STEP_SUMMARY
          fi
